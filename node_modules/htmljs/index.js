'use strict'

/**
 * htmljs(html) -> JS
 */

const utils = require('parse5-utils')

module.exports = function (html, variable) {
  let document = utils.parseFragment(html)

  let js = ''
  traverse(document)
  return `var ${variable || 'HTML'} = ${JSON.stringify(utils.stringify(document).trim())};\n${js}`

  function traverse(node) {
    if (!node || !node.childNodes || !node.childNodes.length) return

    // nodes to remove after traversing this node's children
    let removals = []

    node.childNodes.forEach(function (node) {
      // traverse non-script tags
      if (node.nodeName !== 'script') return traverse(node)

      for (let attr of node.attrs) {
        // ignore script tags with a source
        if (attr.name === 'src') return
        // ignore scripts that aren't javascript
        if (attr.name === 'type' && attr.value !== 'application/javascript') return
      }

      // grab the script's inline text
      let child = node.childNodes[0]
      if (child && child.nodeName === '#text') js += child.value + ';\n'

      removals.push(node)
    })

    node.childNodes = node.childNodes.filter(function (node) {
      return !~removals.indexOf(node)
    })
  }
}
